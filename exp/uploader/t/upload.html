<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
    <title>Upload</title>
    <style type="text/css">
      #dropzone {
        margin-left: 205px;
        height: 100px;
        border: 1px solid black;
        border-radius: 10px;
        background-color: #def;
        line-height: 100px;
        text-align: center;
      }
      #dropzone:hover {
        background-color: #eef;
      }
      #dropzone.active {
        background-color: #ddf;
      }
      .blinking {
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
    <script type="text/javascript">
      function init() {
        const dropzone = document.querySelector("#dropzone");
        dropzone.addEventListener("dragover", (event) => {
          event.preventDefault();
          dropzone.classList.add("active");
        });
        dropzone.addEventListener("dragleave", (event) => {
          dropzone.classList.remove("active");
        });
        dropzone.addEventListener("drop", (event) => {
          event.preventDefault();
          const files = event.dataTransfer.files;
          const username = document.getElementById("username").value;
          if (username == "") {
            write(true, "Username missing");
            return;
          }
          var stats = { total: files.length, uploaded: [], failed: [] };
          write(true, '<span class="blinking">Uploading...</span>');
          for (const file of files) {
            upload(file, stats);
          }
        });
      }
      function upload(file, stats) {
        const formData = new FormData(document.getElementById("form"));
        formData.append("file", file);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload", true);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.send(formData);
        xhr.onload = function () {
          if (xhr.status === 200) {
            stats.uploaded.push(file);
          } else {
            stats.failed.push(file);
          }
          writeStats(stats);
        };
      }
      function write(clear, ...args) {
        var msg = "";
        if (!clear) {
          msg = document.getElementById("msg").innerHTML;
        }
        for (var i = 0; i < args.length; i++) {
          if (typeof args[i] === "number") {
            msg += args[i].toString();
          } else {
            msg += args[i];
          }
        }
        msg += "<br>";
        document.getElementById("msg").innerHTML = msg;
      }
      function writeStats(stats) {
        write(true, "Total files: ", stats.total);
        write(false, "Uploaded files: ", stats.uploaded.length);
        for (var i = 0; i < stats.uploaded.length; i++) {
          write(false, "&bull; ", stats.uploaded[i].name, " (", stats.uploaded[i].size, " bytes)");
        }
        if (stats.failed.length == 0) {
          return;
        }
        write(false, "Failed to upload: ", stats.failed.length);
        for (var i = 0; i < stats.failed.length; i++) {
          write(false, "&bull; ", stats.failed[i].name, " (", stats.failed[i].size, " bytes)");
        }
      }
    </script>
  </head>
  <body onload="init();">
    <h1>Upload</h1>
      <div class="border rounded p-4 container-md bg-white">
      <form action="/upload" method="POST" id="form" enctype="multipart/form-data">
        <fieldset>
          <label>Username:</label>
          <input type="input" name="username" id="username" {{ if .Username }}value="{{ .Username }}" {{ end }} class="w-50" />
          <br />
          <label>Media file:</label>
          <input type="file" name="file" id="file" class="btn btn-primary w-50" />
          <br />
          <div id="dropzone" class="w-50">or drop files here</div>
          <br />
          <input type="submit" name="task" value="Upload" class="btn btn-primary" />
        </fieldset>
      </form>
      <br>
      </div>
      <div id="msg">{{ if .Msg }}{{ .Msg }}{{ end }}
      </div>
  </body>
</html>
